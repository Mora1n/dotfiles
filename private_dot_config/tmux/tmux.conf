# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# TMUX CONFIGURATION
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# ─────────────────────────────────────────────────────────────────────────────
# Terminal
# ─────────────────────────────────────────────────────────────────────────────
set -g default-terminal "$TERM"                  # Enable 256-color support

# ─────────────────────────────────────────────────────────────────────────────
# Input & Navigation
# ─────────────────────────────────────────────────────────────────────────────
set -g mouse on                                  # Full mouse interaction support
set -g mode-keys vi                              # Vim-style key bindings

# ─────────────────────────────────────────────────────────────────────────────
# Performance
# ─────────────────────────────────────────────────────────────────────────────
set -sg escape-time 0                            # Instant escape key response
set -g repeat-time 600                           # Key repeat timeout
set -g focus-events on                           # Application focus detection
set -g aggressive-resize on                      # Smart window resizing

# ─────────────────────────────────────────────────────────────────────────────
# Auto Renumbering
# ─────────────────────────────────────────────────────────────────────────────
set -g renumber-windows on                       # Auto renumber windows

# ─────────────────────────────────────────────────────────────────────────────
# Status Bar
# ─────────────────────────────────────────────────────────────────────────────
set -g status-position top                       # Status bar placement
set -g status-justify left                       # Left-aligned window list

# ─────────────────────────────────────────────────────────────────────────────
# Prefix Keys
# ─────────────────────────────────────────────────────────────────────────────
unbind C-b
set -g prefix M-z                                # Primary prefix
set -g prefix2 C-a                               # Secondary prefix
bind M-Z send-prefix
bind C-a send-prefix -2

# ─────────────────────────────────────────────────────────────────────────────
# Session Management
# ─────────────────────────────────────────────────────────────────────────────

# Search and navigation
bind a choose-session                            # Attach session
bind s new-session                               # New session
bind d detach-client                             # Detach session
bind BSpace switch-client -l                     # Last session
bind -r ( switch-client -p                       # Previous session
bind -r ) switch-client -n                       # Next session

# Management
bind S display-popup -E "\
    (tmux list-sessions -F '#{?session_attached,* ,  }#{session_name}' | grep '^\*'; \
     tmux list-sessions -F '#{?session_attached,* ,  }#{session_name}' | grep -v '^\*') |\
    fzf --reverse --header kill-session |\
    sed 's/^[* ] *//' |\
    xargs -r tmux kill-session -t"               # fzf kill session

# ─────────────────────────────────────────────────────────────────────────────
# Window Management
# ─────────────────────────────────────────────────────────────────────────────

# Search and navigation
bind -r n next-window                            # Next window
bind -r p previous-window                        # Previous window
bind -r Tab last-window                          # Last window

# Management
bind W display-popup -E "\
    (tmux list-windows -F '#{?window_active,* ,  }#{window_index} #{window_name}' | grep '^\*'; \
     tmux list-windows -F '#{?window_active,* ,  }#{window_index} #{window_name}' | grep -v '^\*') |\

    fzf --reverse --header kill-window |\
    sed 's/^[* ] *//' | cut -d' ' -f1 |\
    xargs -r tmux kill-window -t"                # fzf kill window
bind -r < swap-window -d -t -1                   # Move left (plugin provided)
bind -r > swap-window -d -t +1                   # Move right (plugin provided)

# ─────────────────────────────────────────────────────────────────────────────
# Pane Management
# ─────────────────────────────────────────────────────────────────────────────

# Management and layout
bind -r Space next-layout                        # Cycle layouts
bind z resize-pane -Z                            # Zoom/unzoom pane
bind x kill-pane                                 # Kill pane
bind ! break-pane                                # Break to window
bind q display-panes                             # Show pane numbers
bind o select-pane -t :.+                        # Cycle panes
bind = setw synchronize-panes                    # Toggle sync input

# ─────────────────────────────────────────────────────────────────────────────
# Copy Mode
# ─────────────────────────────────────────────────────────────────────────────

bind v copy-mode                                 # Enter copy mode
bind [ copy-mode                                 # Enter copy mode (tmux default)
bind ] paste-buffer                              # Paste
bind P choose-buffer                             # Choose buffer

# Vim bindings in copy-mode
# Selection
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi V send-keys -X select-line
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Y send-keys -X copy-end-of-line

# Exit and cancel
bind -T copy-mode-vi q send-keys -X cancel
bind -T copy-mode-vi Escape send-keys -X clear-selection

# Line navigation
bind -T copy-mode-vi 0 send-keys -X start-of-line
bind -T copy-mode-vi ^ send-keys -X back-to-indentation
bind -T copy-mode-vi $ send-keys -X end-of-line
bind -T copy-mode-vi g send-keys -X top-line
bind -T copy-mode-vi G send-keys -X bottom-line

# Word navigation
bind -T copy-mode-vi w send-keys -X next-word
bind -T copy-mode-vi W send-keys -X next-space
bind -T copy-mode-vi e send-keys -X next-word-end
bind -T copy-mode-vi E send-keys -X next-space-end
bind -T copy-mode-vi b send-keys -X previous-word
bind -T copy-mode-vi B send-keys -X previous-space

# Paragraph navigation
bind -T copy-mode-vi '{' send-keys -X previous-paragraph
bind -T copy-mode-vi '}' send-keys -X next-paragraph

# Page navigation
bind -T copy-mode-vi C-u send-keys -X halfpage-up
bind -T copy-mode-vi C-d send-keys -X halfpage-down
bind -T copy-mode-vi C-b send-keys -X page-up
bind -T copy-mode-vi C-f send-keys -X page-down

# Scrolling
bind -T copy-mode-vi C-e send-keys -X scroll-down
bind -T copy-mode-vi C-y send-keys -X scroll-up

# Search
bind -T copy-mode-vi / command-prompt -p "(search down)" "send -X search-forward \"%%%\""
bind -T copy-mode-vi ? command-prompt -p "(search up)" "send -X search-backward \"%%%\""
bind -T copy-mode-vi n send-keys -X search-again
bind -T copy-mode-vi N send-keys -X search-reverse

# Jump to character
bind -T copy-mode-vi f command-prompt -1 -p "(jump forward)" "send -X jump-forward \"%%%\""
bind -T copy-mode-vi F command-prompt -1 -p "(jump backward)" "send -X jump-backward \"%%%\""
bind -T copy-mode-vi t command-prompt -1 -p "(jump to forward)" "send -X jump-to-forward \"%%%\""
bind -T copy-mode-vi T command-prompt -1 -p "(jump to backward)" "send -X jump-to-backward \"%%%\""
bind -T copy-mode-vi ';' send-keys -X jump-again
bind -T copy-mode-vi ',' send-keys -X jump-reverse

# Line jumps
bind -T copy-mode-vi H send-keys -X top-line
bind -T copy-mode-vi M send-keys -X middle-line
bind -T copy-mode-vi L send-keys -X bottom-line

# ─────────────────────────────────────────────────────────────────────────────
# Clipboard Integration
# ─────────────────────────────────────────────────────────────────────────────

bind C-c run "tmux save-buffer - | xsel -i -b"   # Copy to system clipboard
bind C-v run "tmux set-buffer \"$(xsel -o -b)\"; tmux paste-buffer" # Paste from system
set -g set-clipboard on                          # Auto clipboard sync

# ─────────────────────────────────────────────────────────────────────────────
# Utilities
# ─────────────────────────────────────────────────────────────────────────────

bind r source-file ~/.config/tmux/tmux.conf \; display "✓ Config reloaded!"
bind ? list-keys                                 # Show all keys
bind : command-prompt                            # Command prompt
bind b set status                                # Toggle status bar

# ─────────────────────────────────────────────────────────────────────────────
# Plugins
# ─────────────────────────────────────────────────────────────────────────────

set -g @plugin "tmux-plugins/tpm"                # Plugin manager
set -g @plugin "tmux-plugins/tmux-sensible"      # Sensible defaults
set -g @plugin "tmux-plugins/tmux-resurrect"     # Session persistence
set -g @plugin "tmux-plugins/tmux-continuum"     # Auto session save/restore
set -g @plugin "tmux-plugins/tmux-pain-control"  # Better pane management
set -g @plugin "tmux-plugins/tmux-yank"          # Enhanced copy/paste
set -g @plugin "wfxr/tmux-fzf-url"               # FZF-based URL opener
set -g @plugin "nhdaly/tmux-better-mouse-mode"   # Enhanced mouse support
set -g @plugin "dracula/tmux"                    # Beautiful theme

# ─────────────────────────────────────────────────────────────────────────────
# Plugin Configuration - Session Persistence
# ─────────────────────────────────────────────────────────────────────────────

set -g @resurrect-strategy-vim "session"         # Restore vim sessions
set -g @resurrect-strategy-nvim "session"        # Restore neovim sessions
set -g @resurrect-capture-pane-contents "on"     # Save pane content
set -g @resurrect-processes 'ssh psql mysql sqlite3' # Restore these processes

# ─────────────────────────────────────────────────────────────────────────────
# Plugin Configuration - Auto Save/Restore
# ─────────────────────────────────────────────────────────────────────────────

set -g @continuum-restore "off"                  # Manual session restore
set -g @continuum-save-interval "300"            # Save every 5 minutes
set -g @continuum-boot "on"                      # Start tmux on system boot

# ─────────────────────────────────────────────────────────────────────────────
# Plugin Configuration - Copy Enhancement
# ─────────────────────────────────────────────────────────────────────────────

set -g @yank_selection_mouse 'clipboard'         # Mouse selection target
set -g @yank_action 'copy-pipe-and-cancel'       # Copy behavior

# ─────────────────────────────────────────────────────────────────────────────
# Plugin Configuration - Mouse Enhancement
# ─────────────────────────────────────────────────────────────────────────────

set -g @scroll-without-changing-pane "on"        # Scroll without switching pane
set -g @emulate-scroll-for-no-mouse-alternate-buffer "on" # Better scrolling

# ─────────────────────────────────────────────────────────────────────────────
# Plugin Configuration - Theme
# ─────────────────────────────────────────────────────────────────────────────

set -g @dracula-plugins "ssh-session synchronize-panes time" # Status modules
set -g @dracula-show-powerline true              # Fancy powerline symbols
set -g @dracula-transparent-powerline-bg true    # Transparent powerline
set -g @dracula-inverse-divider                 # Inverse left separator icon
set -g @dracula-show-left-icon " #S"            # Session icon display
set -g @dracula-synchronize-panes-label "󰌹"      # Synchronize pane display
set -g @dracula-refresh-rate 5                   # Update frequency (seconds)
set -g @dracula-show-empty-plugins false         # Hide inactive modules
set -g @dracula-border-contrast true             # Enhanced border visibility
set -g @dracula-show-flags true                  # Show window flag in status
set -g @dracula-show-ssh-only-when-connected true # Smart SSH visibility
set -g @dracula-show-ssh-session-port true       # Show SSH port numbers
set -g @dracula-time-format "📅%a %m/%d 🕒%I:%M %p" # Date and time format

# ─────────────────────────────────────────────────────────────────────────────
# Initialize Plugin Manager
# ─────────────────────────────────────────────────────────────────────────────

run "~/.config/tmux/plugins/tpm/tpm"
